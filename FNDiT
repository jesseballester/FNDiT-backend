{
  "name": "fndit-backend",
  "version": "1.0.0",
  "type": "module",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.19.2"
  }
}
import express from "express";

const app = express();
const PORT = process.env.PORT || 3000;

const SERPAPI_KEY = process.env.SERPAPI_KEY;

app.get("/", (_req, res) => {
  res.json({ ok: true, service: "fndit-backend" });
});

app.get("/search", async (req, res) => {
  try {
    const q = (req.query.q || "").toString().trim();
    const country = (req.query.country || "GB").toString().trim().toUpperCase();

    if (!q) return res.status(400).json({ error: "Missing q" });
    if (!SERPAPI_KEY) return res.status(500).json({ error: "Missing SERPAPI_KEY" });

    const gl = country === "GB" ? "gb" : "us"; // start with GB; expand later
    const url = new URL("https://serpapi.com/search.json");
    url.searchParams.set("engine", "google_shopping");
    url.searchParams.set("q", q);
    url.searchParams.set("gl", gl);
    url.searchParams.set("hl", "en");
    url.searchParams.set("api_key", SERPAPI_KEY);

    const r = await fetch(url);
    if (!r.ok) {
      const text = await r.text();
      return res.status(502).json({ error: "SerpApi error", detail: text });
    }
    const data = await r.json();

    const items = (data.shopping_results || [])
      .map((it) => {
        const priceStr = (it.extracted_price ?? it.price ?? "").toString();
        const price = Number(it.extracted_price);
        if (!Number.isFinite(price)) return null;

        return {
          title: it.title || "Item",
          store: it.source || "Google Shopping",
          price,
          currency: "GBP",
          url: it.link || it.product_link || ""
        };
      })
      .filter(Boolean)
      .filter((x) => x.url)
      .sort((a, b) => a.price - b.price)
      .slice(0, 3);

    res.json({ query: q, results: items });
  } catch (e) {
    res.status(500).json({ error: "Server error", detail: String(e) });
  }
});

app.listen(PORT, () => {
  console.log(`FNDiT backend listening on ${PORT}`);
});
